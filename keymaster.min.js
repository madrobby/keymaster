//     keymaster.js
//     (c) 2011-2012 Thomas Fuchs
//     keymaster.js may be freely distributed under the MIT license.
!function(a){function m(a,b){for(var c=a.length;c--;)if(a[c]===b)return c;return-1}function n(a,b){if(a.length!=b.length)return!1;for(var c=0;c<a.length;c++)if(a[c]!==b[c])return!1;return!0}function p(a){for(b in d)d[b]=a[o[b]]}function q(a,b){var e,g,h,j,k;if(e=a.keyCode,-1==m(i,e)&&i.push(e),(93==e||224==e)&&(e=91),e in d){d[e]=!0;for(h in f)f[h]==e&&(t[h]=!0)}else if(p(a),t.filter.call(this,a)&&e in c)for(j=0;j<c[e].length;j++)if(g=c[e][j],g.scope==b||"all"==g.scope){k=g.mods.length>0;for(h in d)(!d[h]&&m(g.mods,+h)>-1||d[h]&&-1==m(g.mods,+h))&&(k=!1);(0!=g.mods.length||d[16]||d[18]||d[17]||d[91])&&!k||g.method(a,g)===!1&&(a.preventDefault?a.preventDefault():a.returnValue=!1,a.stopPropagation&&a.stopPropagation(),a.cancelBubble&&(a.cancelBubble=!0))}}function r(a){var c,b=a.keyCode,e=m(i,b);if(e>=0&&i.splice(e,1),(93==b||224==b)&&(b=91),b in d){d[b]=!1;for(c in f)f[c]==b&&(t[c]=!1)}}function s(){for(b in d)d[b]=!1;for(b in f)t[b]=!1}function t(a,b,d){var e,f,g;e=F(a),void 0===d&&(d=b,b="all");for(var i=0;i<e.length;i++)if(f=[],a=e[i].split("+"),a.length>1&&(f=H(a),a=[a[a.length-1]]),a=a[0],G(a)){u(a,d),g=v(a.split("&"));for(var j=0;j<g.length;j++)t(g[j],b,x)}else a=h(a),a in c||(c[a]=[]),c[a].push({shortcut:e[i],scope:b,method:d,key:e[i],mods:f})}function u(a,b){for(var c=a.split("&"),d=0;d<c.length;d++)c[d]=h(c[d]);k[c.join("&")]=b}function v(a){var c,b=[];for(c=0;c<a.length;c++)-1===b.indexOf(a[c])&&b.push(a[c]);return b}function w(a){for(var b=a.split("&"),c=0;c<b.length;c++)b[c]=h(b[c]);delete k[b.join("&")]}function x(a){var b;j.push(a.keyCode),b=k[j.join("&")],void 0!==b&&j.length>1?(clearTimeout(l),j.length=0,b(a,b)):(clearTimeout(l),l=setTimeout(function(){j.length=0},1e3))}function y(a,b){var f,g,i,d=a.split("+"),e=[];if(d.length>1&&(e=H(d),a=d[d.length-1]),G(a)){w(a),i=a.split("&");for(var j=0;j<i.length;j++)y(i[j],b)}if(a=h(a),void 0===b&&(b=D()),c[a])for(f in c[a])g=c[a][f],g.scope===b&&n(g.mods,e)&&(c[a][f]={})}function z(a){return"string"==typeof a&&(a=h(a)),-1!=m(i,a)}function A(){return i.slice(0)}function B(a){var b=(a.target||a.srcElement).tagName;return!("INPUT"==b||"SELECT"==b||"TEXTAREA"==b)}function C(a){e=a||"all"}function D(){return e||"all"}function E(a){var b,d,e;for(b in c)for(d=c[b],e=0;e<d.length;)d[e].scope===a?d.splice(e,1):e++}function F(a){var b;return a=a.replace(/\s/g,""),b=a.split(","),""==b[b.length-1]&&(b[b.length-2]+=","),b}function G(a){return!!a&&a.length>1&&a.indexOf("&")>0}function H(a){for(var b=a.slice(0,a.length-1),c=0;c<b.length;c++)b[c]=f[b[c]];return b}function I(a,b,c){a.addEventListener?a.addEventListener(b,c,!1):a.attachEvent&&a.attachEvent("on"+b,function(){c(window.event)})}function K(){var b=a.key;return a.key=J,b}var b,l,c={},d={16:!1,18:!1,17:!1,91:!1},e="all",f={"\u21e7":16,shift:16,"\u2325":18,alt:18,option:18,"\u2303":17,ctrl:17,control:17,"\u2318":91,command:91},g={backspace:8,tab:9,clear:12,enter:13,"return":13,esc:27,escape:27,space:32,left:37,up:38,right:39,down:40,del:46,"delete":46,home:36,end:35,pageup:33,pagedown:34,",":188,".":190,"/":191,"`":192,"-":189,"=":187,";":186,"'":222,"[":219,"]":221,"\\":220},h=function(a){return g[a]||a.toUpperCase().charCodeAt(0)},i=[],j=[],k={};for(b=1;20>b;b++)g["f"+b]=111+b;var o={16:"shiftKey",18:"altKey",17:"ctrlKey",91:"metaKey"};for(b in f)t[b]=!1;I(document,"keydown",function(a){q(a,e)}),I(document,"keyup",r),I(window,"focus",s);var J=a.key;a.key=t,a.key.setScope=C,a.key.getScope=D,a.key.deleteScope=E,a.key.filter=B,a.key.isPressed=z,a.key.getPressedKeyCodes=A,a.key.noConflict=K,a.key.unbind=y,"undefined"!=typeof module&&(module.exports=key)}(this);